# 时光小账本数据库设计文档

## 1. 数据库概述

### 1.1 基本信息
- **数据库名称**: momento_miniapp
- **数据库版本**: MySQL 5.7
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **存储引擎**: InnoDB

### 1.2 设计原则
1. 所有时间戳字段使用秒级时间戳（INT(10) UNSIGNED）
2. 用户UID使用雪花算法生成的字符串ID（VARCHAR(20)）
3. 其他业务主键使用INT自增ID
4. 金额字段使用DECIMAL(10,2)精确存储
5. 所有表都包含created_at和updated_at字段
6. 合理使用索引提高查询效率

---

## 2. 表结构设计

### 2.1 用户相关表

#### 2.1.1 users（用户表）

**表说明**: 存储用户基本信息

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| uid | VARCHAR(20) | 是 | - | 用户唯一ID（雪花算法） |
| openid | VARCHAR(64) | 是 | '' | 微信openid |
| unionid | VARCHAR(64) | 是 | '' | 微信unionid |
| nickname | VARCHAR(50) | 是 | '' | 用户昵称 |
| avatar | VARCHAR(255) | 是 | '' | 用户头像URL |
| phone | VARCHAR(20) | 是 | '' | 手机号 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |
| updated_at | INT(10) UNSIGNED | 是 | 0 | 更新时间 |

**索引**:
- PRIMARY KEY: uid
- UNIQUE KEY: openid
- KEY: phone, created_at

#### 2.1.2 user_settings（用户设置表）

**表说明**: 存储用户个性化设置

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| id | INT(10) UNSIGNED | 是 | - | 主键ID |
| uid | VARCHAR(20) | 是 | - | 用户ID |
| background_url | VARCHAR(255) | 是 | '' | 首页背景图片URL |
| budget | DECIMAL(10,2) | 是 | 0.00 | 月度预算 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |
| updated_at | INT(10) UNSIGNED | 是 | 0 | 更新时间 |

**索引**:
- PRIMARY KEY: id
- UNIQUE KEY: uid

---

### 2.2 账本相关表

#### 2.2.1 account_books（账本表）

**表说明**: 存储账本基本信息

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| book_id | INT(10) UNSIGNED | 是 | - | 账本ID |
| name | VARCHAR(50) | 是 | '' | 账本名称 |
| creator_uid | VARCHAR(20) | 是 | - | 创建者UID |
| member_count | INT(10) UNSIGNED | 是 | 1 | 成员数量 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |
| updated_at | INT(10) UNSIGNED | 是 | 0 | 更新时间 |

**索引**:
- PRIMARY KEY: book_id
- KEY: creator_uid, created_at

#### 2.2.2 account_book_members（账本成员表）

**表说明**: 存储账本成员关系

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| id | INT(10) UNSIGNED | 是 | - | 主键ID |
| book_id | INT(10) UNSIGNED | 是 | - | 账本ID |
| uid | VARCHAR(20) | 是 | - | 用户ID |
| is_creator | TINYINT(1) | 是 | 0 | 是否为创建者 |
| is_default | TINYINT(1) | 是 | 0 | 是否为默认账本 |
| status | ENUM | 是 | joined | 成员状态 |
| joined_at | INT(10) UNSIGNED | 是 | 0 | 加入时间 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |
| updated_at | INT(10) UNSIGNED | 是 | 0 | 更新时间 |

**status枚举值**:
- joined: 已加入
- waiting: 等待中
- rejected: 已拒绝

**索引**:
- PRIMARY KEY: id
- UNIQUE KEY: (book_id, uid)
- KEY: uid, status

#### 2.2.3 account_book_invitations（账本邀请表）

**表说明**: 存储账本邀请记录

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| invitation_id | INT(10) UNSIGNED | 是 | - | 邀请ID |
| book_id | INT(10) UNSIGNED | 是 | - | 账本ID |
| inviter_uid | VARCHAR(20) | 是 | - | 邀请人UID |
| target_uid | VARCHAR(20) | 是 | - | 被邀请人UID |
| status | ENUM | 是 | pending | 邀请状态 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |
| updated_at | INT(10) UNSIGNED | 是 | 0 | 更新时间 |

**status枚举值**:
- pending: 待处理
- accepted: 已接受
- rejected: 已拒绝

**索引**:
- PRIMARY KEY: invitation_id
- KEY: book_id, target_uid, status

---

### 2.3 标签相关表

#### 2.3.1 tags（标签表）

**表说明**: 存储系统标签和用户自定义标签

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| tag_id | INT(10) UNSIGNED | 是 | - | 标签ID |
| uid | VARCHAR(20) | 是 | '' | 用户ID（系统标签为空） |
| name | VARCHAR(20) | 是 | '' | 标签名称 |
| color | VARCHAR(20) | 是 | #4CAF50 | 标签颜色 |
| icon | VARCHAR(50) | 是 | tag | 标签图标 |
| is_system | TINYINT(1) | 是 | 0 | 是否为系统标签 |
| type | ENUM | 是 | expense | 标签类型 |
| sort_order | INT(10) UNSIGNED | 是 | 0 | 排序顺序 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |
| updated_at | INT(10) UNSIGNED | 是 | 0 | 更新时间 |

**type枚举值**:
- expense: 支出
- income: 收入

**索引**:
- PRIMARY KEY: tag_id
- KEY: (uid, type), is_system

---

### 2.4 交易记录相关表

#### 2.4.1 transactions（交易记录表）

**表说明**: 存储所有交易记录

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| transaction_id | INT(10) UNSIGNED | 是 | - | 交易记录ID |
| book_id | INT(10) UNSIGNED | 是 | - | 账本ID |
| uid | VARCHAR(20) | 是 | - | 用户ID |
| type | ENUM | 是 | expense | 交易类型 |
| amount | DECIMAL(10,2) | 是 | 0.00 | 金额 |
| tag_id | INT(10) UNSIGNED | 是 | - | 标签ID |
| remark | VARCHAR(255) | 是 | '' | 备注 |
| transaction_time | INT(10) UNSIGNED | 是 | 0 | 交易时间 |
| is_auto_generated | TINYINT(1) | 是 | 0 | 是否自动生成 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |
| updated_at | INT(10) UNSIGNED | 是 | 0 | 更新时间 |

**type枚举值**:
- expense: 支出
- income: 收入

**索引**:
- PRIMARY KEY: transaction_id
- KEY: book_id, uid, type, tag_id, transaction_time, created_at

---

### 2.5 周期性记账相关表

#### 2.5.1 recurring_transactions（周期性记账表）

**表说明**: 存储周期性记账规则

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| recurring_id | INT(10) UNSIGNED | 是 | - | 周期性记账ID |
| book_id | INT(10) UNSIGNED | 是 | - | 账本ID |
| uid | VARCHAR(20) | 是 | - | 用户ID |
| name | VARCHAR(50) | 是 | '' | 记账名称 |
| type | ENUM | 是 | expense | 交易类型 |
| amount | DECIMAL(10,2) | 是 | 0.00 | 金额 |
| tag_id | INT(10) UNSIGNED | 是 | - | 标签ID |
| remark | VARCHAR(255) | 是 | '' | 备注 |
| recurring_type | ENUM | 是 | monthly | 周期类型 |
| recurring_hour | TINYINT(2) UNSIGNED | 是 | 9 | 执行小时 |
| recurring_minute | TINYINT(2) UNSIGNED | 是 | 0 | 执行分钟 |
| recurring_weekday | TINYINT(1) UNSIGNED | 否 | NULL | 星期几 |
| recurring_month | TINYINT(2) UNSIGNED | 否 | NULL | 月份 |
| recurring_day | TINYINT(2) UNSIGNED | 否 | NULL | 日期 |
| is_recurring_enabled | TINYINT(1) | 是 | 1 | 是否启用 |
| last_executed_at | INT(10) UNSIGNED | 是 | 0 | 最后执行时间 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |
| updated_at | INT(10) UNSIGNED | 是 | 0 | 更新时间 |

**recurring_type枚举值**:
- daily: 每天
- weekly: 每周
- monthly: 每月
- quarterly: 每季度
- yearly: 每年

**索引**:
- PRIMARY KEY: recurring_id
- KEY: book_id, uid, type, is_recurring_enabled

---

### 2.6 节日相关表

#### 2.6.1 festivals（节日表）

**表说明**: 存储用户自定义节日

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| festival_id | INT(10) UNSIGNED | 是 | - | 节日ID |
| uid | VARCHAR(20) | 是 | - | 用户ID |
| festival_name | VARCHAR(50) | 是 | '' | 节日名称 |
| festival_date | INT(8) UNSIGNED | 是 | 0 | 节日日期（YYYYMMDD） |
| is_show_home | TINYINT(1) | 是 | 1 | 是否在首页显示 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |
| updated_at | INT(10) UNSIGNED | 是 | 0 | 更新时间 |

**索引**:
- PRIMARY KEY: festival_id
- KEY: uid, festival_date, is_show_home

---

### 2.7 文件上传相关表

#### 2.7.1 upload_files（文件上传记录表）

**表说明**: 存储文件上传记录

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| file_id | INT(10) UNSIGNED | 是 | - | 文件ID |
| uid | VARCHAR(20) | 是 | - | 用户ID |
| relative_path | VARCHAR(255) | 是 | '' | 文件相对路径 |
| absolute_url | VARCHAR(255) | 是 | '' | 文件绝对URL |
| file_size | INT(10) UNSIGNED | 是 | 0 | 文件大小（字节） |
| file_type | VARCHAR(20) | 是 | '' | 文件类型 |
| business_type | VARCHAR(50) | 是 | '' | 业务类型 |
| upload_time | INT(10) UNSIGNED | 是 | 0 | 上传时间 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |

**business_type说明**:
- user_avatar: 用户头像
- background: 背景图片
- transaction_image: 交易记录图片

**索引**:
- PRIMARY KEY: file_id
- KEY: uid, business_type, upload_time

---

### 2.8 系统相关表

#### 2.8.1 request_logs（请求日志表）

**表说明**: 存储API请求日志，用于防重复提交

| 字段名 | 类型 | 是否必填 | 默认值 | 说明 |
|--------|------|----------|--------|------|
| id | BIGINT(20) UNSIGNED | 是 | - | 主键ID |
| request_id | VARCHAR(64) | 是 | - | 请求唯一标识 |
| uid | VARCHAR(20) | 是 | '' | 用户ID |
| api_path | VARCHAR(255) | 是 | '' | API路径 |
| request_data | TEXT | 否 | NULL | 请求数据 |
| response_data | TEXT | 否 | NULL | 响应数据 |
| status_code | INT(10) UNSIGNED | 是 | 0 | 状态码 |
| created_at | INT(10) UNSIGNED | 是 | 0 | 创建时间 |

**索引**:
- PRIMARY KEY: id
- UNIQUE KEY: request_id
- KEY: uid, created_at

---

## 3. 表关系说明

### 3.1 用户与账本
- 一个用户可以创建多个账本（1:N）
- 一个用户可以加入多个账本（N:N，通过account_book_members表）
- 一个账本可以有多个成员（1:N）

### 3.2 账本与交易记录
- 一个账本可以有多条交易记录（1:N）
- 一条交易记录只属于一个账本（N:1）

### 3.3 用户与标签
- 系统标签：所有用户共享（uid为空）
- 用户标签：每个用户独立维护（uid不为空）

### 3.4 标签与交易记录
- 一个标签可以被多条交易记录使用（1:N）
- 一条交易记录只能使用一个标签（N:1）

### 3.5 用户与周期性记账
- 一个用户可以创建多个周期性记账规则（1:N）
- 周期性记账规则会自动生成交易记录

---

## 4. 数据字典

### 4.1 枚举值说明

#### 成员状态（account_book_members.status）
- `joined`: 已加入
- `waiting`: 等待中
- `rejected`: 已拒绝

#### 邀请状态（account_book_invitations.status）
- `pending`: 待处理
- `accepted`: 已接受
- `rejected`: 已拒绝

#### 交易类型（transactions.type, recurring_transactions.type）
- `expense`: 支出
- `income`: 收入

#### 标签类型（tags.type）
- `expense`: 支出标签
- `income`: 收入标签

#### 周期类型（recurring_transactions.recurring_type）
- `daily`: 每天
- `weekly`: 每周
- `monthly`: 每月
- `quarterly`: 每季度
- `yearly`: 每年

---

## 5. 索引设计说明

### 5.1 索引原则
1. 主键索引：所有表都有主键
2. 唯一索引：保证数据唯一性（如openid、request_id）
3. 普通索引：提高查询效率（如时间字段、外键字段）
4. 组合索引：优化多条件查询（如uid+type）

### 5.2 索引优化建议
1. 避免在低基数字段上建立索引
2. 组合索引遵循最左前缀原则
3. 定期分析慢查询日志，优化索引
4. 控制索引数量，避免过多索引影响写入性能

---

## 6. 性能优化建议

### 6.1 分区策略
- transactions表：按月分区（基于transaction_time）
- request_logs表：按月分区（基于created_at）

### 6.2 缓存策略
- 用户信息：Redis缓存，过期时间30分钟
- 系统标签：Redis缓存，永久有效
- 账本列表：Redis缓存，过期时间10分钟

### 6.3 查询优化
- 使用LIMIT限制返回结果数量
- 避免SELECT *，只查询需要的字段
- 使用覆盖索引减少回表查询
- 合理使用JOIN，避免过多关联

---

## 7. 数据安全

### 7.1 备份策略
- 全量备份：每天凌晨2点
- 增量备份：每小时一次
- 备份保留：30天

### 7.2 数据加密
- 敏感字段加密：phone（AES加密）
- 传输加密：HTTPS
- 存储加密：数据库透明加密

### 7.3 权限控制
- 应用层：基于token的用户认证
- 数据库层：最小权限原则
- 审计日志：记录所有数据变更

---

## 8. 扩展性设计

### 8.1 水平扩展
- 用户表：按uid哈希分库分表
- 交易记录表：按book_id分库分表

### 8.2 垂直扩展
- 读写分离：主库写，从库读
- 冷热数据分离：历史数据归档

### 8.3 预留字段
- 各表预留扩展字段（ext_data JSON类型）
- 支持未来功能扩展
